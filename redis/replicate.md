## 复制
在 Redis 中，用户可以通过执行 SLAVEOF 命令或者设置 slaveof 选项，让一个服务器去复制（replicate）另一个服务器，被复制的服务器为主服务器（master），而对主服务器进行复制的服务器则被称为从服务器。主从服务器双方的数据库保存相同的数据，这种现象称为“数据库状态一致”，或者简称“一致”。

### 复制功能的实现
Redis 复制功能分为同步（sync）和命令传播（command propagate）两个操作：
- 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态；
- 命令传播操作则是用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。

从服务器对主服务器的同步操作需要通过向主服务器发送 SYNC 命令来完成，以下是 SYNC 命令的执行步骤：
1. 从服务器向主服务器发送 SYNC 命令；
2. 收到 SYNC 命令的主服务器执行 BGSAVE 命令，在后台生产一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令；？？
3. 当主服务器的 BGSAVE 命令执行完毕，主服务器会将 BGSAVE 命令生产的 RDB 文件发送给从服务器，从服务器接受并载入这个 RDB 文件，将自己的数据库状态更新至主服务器执行 BGSAVE 命令时的数据库状态；
4. 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器状态当前所处的状态。

在同步操作执行完毕之后，主从服务器两者的数据库将达到一致状态。但每当主服务器执行客户端发送的写命令时，主服务器的数据库就有可能被修改，导致主从服务器状态不再一致。

为了让主从服务器再次回到一致状态，主服务器需要对从服务器执行命令传播操作：主服务器将自己执行的写命令，发送给从服务器执行，保证主从服务器处于一致状态。

为了解决旧版复制功能在处理断线重连后复制低效问题，Redis 从 2.8 版本开始，使用 PSYNC 命令代替 SYNC 命令来执行同步操作。

PSYNC 命令具有完整重同步和部分重同步两种模式
- 完整重同步用于处理初次复制情况，和 SYNC 的步骤相似
- 部分重同步用于处理断线重连后重复制情况：当从服务器在断线后重新连上主服务时，如果条件允许，主服务将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接受并执行这些写命令，就可以将数据库更新至主服务当前所处的状态。

PSYNC 部分重同步的实现依靠以下三个数据结构：
- 主从服务器的复制偏移量（replication offset）
- 主服务器的复制积压缓冲区（replication backlog）
- 服务器的运行 ID

执行复制的双方--主服务器和从服务器会分别维护一个复制偏移量：
- 主服务器每次向从服务器传播 N 个字节的数据时，就将自己复制偏移量的值递增 N
- 从服务器每次收到主服务器传播来的 N 个字节的数据时，就将自己的复制偏移量递增 N

从服务器在断线之后立即重新成功连接上主服务器，从服务器将向主服务器发送 PSYNC 命令，并报告自己当前的复制偏移量。主服务在收到 PSYNC 命令后，根据复制积压缓冲区的状态选择执行部分重同步还是完整重同步。

复制积压缓冲区是主服务器维护的一个固定长度、先进先出队列，默认大小为 1MB。当主服务进行命令传播时，不仅会将写命令发送给所有从服务器，还会将写命令写入复制积压缓冲区中。当从服务器重新连上主服务器时并发送 PSYNC 命令，主服务器会根据从服务的复制偏移量 offset 决定对从服务器执行何种同步操作：
- 如果 offset 之后的数据仍然存在于复制积压缓冲区中，那么主服务器将对从服务器执行部分重同步操作；
- 相反，如果 offset 之后的数据已经不存在于复制积压缓冲区中，那么主服务将对从服务器执行完整重同步操作。

除了复制偏移量和复制积压缓冲区之外，部分重同步还依靠服务器运行 ID（由 40 个随机的 16 进制字符组成）。每个 Redis 服务器，不论主服务器还是从服务器，都会有自己的运行 ID。当从服务器对主服务器进行初次复制时，主服务器将自己的 ID 传送给从服务器，而从服务器将这个 ID 保存起来。当从服务器断线并重新连上一个主服务器，从服务器将向当前连接的主服务器发送之前保存的 ID，如果两个 ID 相同，说明从服务器断线之前复制的就是当前连接的这个主服务器，主服务器可以继续尝试执行部分重同步操作；相反，主服务器执行完整重同步操作。

### 复制的实现
1. 设置主服务器的地址和端口：从服务器将客户端指定的主服务地址及端口号保存在 masterhost 和 masterport 里面；
2. 建立套接字连接
3. 发送 PING 命令：（1）检查套接字连接读写是否正常；（2）检查主服务器能否正确处理命令请求；
4. 如果从服务器设置了 masterauth 选项，进行身份验证；
5. 发送端口信息
6. 同步
7. 命令传播

### 心跳检测
在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令：
1. 检测主从服务器的网络连接状态
2. 辅助实现 min-slaves 配置选项
3. 检测命令丢失